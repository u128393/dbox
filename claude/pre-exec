#!/bin/bash

set -e

if ! command -v claude &>/dev/null; then
  echo -e "ðŸ”§ Claude æœªå®‰è£…ï¼Œæ­£åœ¨ä½¿ç”¨å®˜æ–¹è„šæœ¬å®‰è£…...\n"
  curl -fsSL https://claude.ai/install.sh | bash
fi

CLAUDE_JSON="$HOME/.claude.json"
SETTINGS_JSON="$HOME/.claude/settings.json"

if [[ ! -f "$CLAUDE_JSON" ]] || ! jq -e '.hasCompletedOnboarding == true' "$CLAUDE_JSON" &>/dev/null; then
  read -p "ðŸ”” Claude å°šæœªåˆå§‹åŒ–ï¼Œæ˜¯å¦é…ç½®çŽ¯å¢ƒå˜é‡è¿žæŽ¥ä¸‰æ–¹å¹³å°ï¼Ÿ[y/N] "

  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    read -p $'\033[1;31m*\033[0m ANTHROPIC_BASE_URL: ' ANTHROPIC_BASE_URL
    read -p $'\033[1;31m*\033[0m ANTHROPIC_AUTH_TOKEN: ' ANTHROPIC_AUTH_TOKEN
    read -p "  ANTHROPIC_MODEL: " ANTHROPIC_MODEL

    if [[ ! -f "$SETTINGS_JSON" ]]; then
      echo '{}' > "$SETTINGS_JSON"
    fi

    # åŠ¨æ€æž„å»º jq å‚æ•°å’Œæ›´æ–°è¡¨è¾¾å¼ï¼ˆåªåŒ…å«éžç©ºçš„å€¼ï¼‰
    jq_args=(
      --arg base_url "$ANTHROPIC_BASE_URL"
      --arg auth_token "$ANTHROPIC_AUTH_TOKEN"
    )
    jq_updates=(
      '"ANTHROPIC_BASE_URL": $base_url'
      '"ANTHROPIC_AUTH_TOKEN": $auth_token'
    )

    if [[ -n "$ANTHROPIC_MODEL" ]]; then
      jq_args+=(--arg model "$ANTHROPIC_MODEL")
      jq_updates+=('"ANTHROPIC_MODEL": $model')
    fi

    jq_updates+=('"CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": 1')

    IFS=, jq_update_str="${jq_updates[*]}"
    jq -S "${jq_args[@]}" ".env |= (. // {}) * { $jq_update_str }" "$SETTINGS_JSON" | sponge "$SETTINGS_JSON"

    if [[ ! -f "$CLAUDE_JSON" ]]; then
      echo '{}' > "$CLAUDE_JSON"
    fi

    jq -S '.hasCompletedOnboarding = true' "$CLAUDE_JSON" | sponge "$CLAUDE_JSON"
  fi
fi
